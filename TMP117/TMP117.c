/*
  @
  @   Date               :        1.3.2021
  @
  @																Writing by zhenzhen
  @
  @   Description        :        This Library is about TMP117 Temperature Sensor on Texas Instruments.
  @                               This is depend on Standard library for STM32 series and software simulation of SMBus.
  @
*/
/*
		日期：2021年3月1日
		这个文件是关于德州仪器的TMP117的例程。
		基于STM32标准库用软件模拟的方式实现SMBus通讯对TMP117寄存器读写。
*/


#include "TMP117.h"

/*******************************************************************************
* 函数名: TMP117 发起始位 SMBus_StartBit
* 功能  : TMP117 发起始位 产生起始位
* Input          : None
* Output         : None
* Return         : None

*******************************************************************************/
void SMBus_StartBit(void)
{
    SMBUS_SDA_H();		// Set SDA line
    SMBus_Delay(5);	    // Wait a few microseconds
    SMBUS_SCK_H();		// Set SCL line
    SMBus_Delay(5);	    // Generate bus free time between Stop
    SMBUS_SDA_L();		// Clear SDA line
    SMBus_Delay(5);	    // Hold time after (Repeated) Start
    // Condition. After this period, the first clock is generated.
    //(Thd:sta=4.0us min)在SCK=1时，检测到SDA由1到0表示通信开始（下降沿）
    SMBUS_SCK_L();	    // Clear SCL line
    SMBus_Delay(5);	    // Wait a few microseconds
}

/*******************************************************************************
* 函数名: SMBus_StopBit
* 功能: TMP117 发停止位 STOP condition on SMBus
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SMBus_StopBit(void)
{
    SMBUS_SCK_L();		// Clear SCL line
    SMBus_Delay(5);	    // Wait a few microseconds
    SMBUS_SDA_L();		// Clear SDA line
    SMBus_Delay(5);	    // Wait a few microseconds
    SMBUS_SCK_H();		// Set SCL line
    SMBus_Delay(5);	    // Stop condition setup time(Tsu:sto=4.0us min)
    SMBUS_SDA_H();		// Set SDA line
}

/*******************************************************************************
* 函数名: SMBus_SendByte
* 功能: TMP117 发送一个字节 Send a byte on SMBus
* Input          : Tx_buffer
* Output         : None
* Return         : None
*******************************************************************************/
u8 SMBus_SendByte(u8 Tx_buffer)
{
    u8	Bit_counter;
    u8	Ack_bit;
    u8	bit_out;

    for(Bit_counter=8; Bit_counter; Bit_counter--)
    {
        if (Tx_buffer&0x80)//如果最高位为1
        {
            bit_out=1;   // 把最高位置1
        }
        else  //如果最高位为0
        {
            bit_out=0;  // 把最高位置0
        }
        SMBus_SendBit(bit_out);	// 把最高位发送出去
        Tx_buffer<<=1;// 左移一位把最高位移出去等待下一个最高位，循环8次，每次都发最高位，就可把一个字节发出去了
    }
    Ack_bit=SMBus_ReceiveBit();
    return	Ack_bit;
}

/*******************************************************************************
* 函数名: SMBus_SendBit
* 功能: TMP117 发送一个位 Send a bit on SMBus 82.5kHz
* Input          : bit_out
* Output         : None
* Return         : None
*******************************************************************************/
void SMBus_SendBit(u8 bit_out)
{
    if(bit_out==0)
    {
        SMBUS_SDA_L();
    }
    else
    {
        SMBUS_SDA_H();
    }
    SMBus_Delay(2);					// Tsu:dat = 250ns minimum
    SMBUS_SCK_H();					// Set SCL line
    SMBus_Delay(6);					// High Level of Clock Pulse
    SMBUS_SCK_L();					// Clear SCL line
    SMBus_Delay(3);					// Low Level of Clock Pulse
//	SMBUS_SDA_H();				    // Master release SDA line ,
    return;
}

/*******************************************************************************
* Function Name  : SMBus_ReceiveBit
* Description    : Receive a bit on SMBus
* Input          : None
* Output         : None
* Return         : Ack_bit
*******************************************************************************/
u8 SMBus_ReceiveBit(void)
{
    u8 Ack_bit;

    SMBUS_SDA_H();          //引脚靠外部电阻上拉，当作输入
	SMBus_Delay(2);			// High Level of Clock Pulse
    SMBUS_SCK_H();			// Set SCL line
    SMBus_Delay(5);			// High Level of Clock Pulse
    if (SMBUS_SDA_PIN())
    {
        Ack_bit=1;
    }
    else
    {
        Ack_bit=0;
    }
    SMBUS_SCK_L();			// Clear SCL line
    SMBus_Delay(3);			// Low Level of Clock Pulse

    return	Ack_bit;
}

/*******************************************************************************
* 函数名: SMBus_ReceiveByte
* 功能: Receive a byte on SMBus 从SMBus中接受一个字节的数据
* Input          : ack_nack
* Output         : None
* Return         : RX_buffer
*******************************************************************************/
u8 SMBus_ReceiveByte(u8 ack_nack)
{
    u8 	RX_buffer;
    u8	Bit_Counter;

    for(Bit_Counter=8; Bit_Counter; Bit_Counter--)
    {
        if(SMBus_ReceiveBit())// Get a bit from the SDA line
        {
            RX_buffer <<= 1;// If the bit is HIGH save 1  in RX_buffer
            RX_buffer |=0x01;//如果Ack_bit=1，把收到应答信号1与0000 0001 进行或运算，确保为1
        }
        else
        {
            RX_buffer <<= 1;// If the bit is LOW save 0 in RX_buffer
            RX_buffer &=0xfe;//如果Ack_bit=1，把收到应答信号0与1111 1110 进行与运算，确保为0
        }
    }
    SMBus_SendBit(ack_nack);// Sends acknowledgment bit 把应答信号发出去，如果1，就进行下一次通信，如果为0、，就拜拜了
    return RX_buffer;
}

/*******************************************************************************
* 函数名: SMBus_Delay
* 功能: 延时  一次循环约1us
* Input          : time
* Output         : None
* Return         : None
*******************************************************************************/
void SMBus_Delay(u16 time)
{
    u16 i, j;
    for (i=0; i<4; i++)
    {
        for (j=0; j<time; j++);
    }
}

/*******************************************************************************
* 函数名: SMBus_Init
* 功能: SMBus初始化
* Input          : None
* Output         : None
* Return         : None
*******************************************************************************/
void SMBus_Init()
{
	GPIO_InitTypeDef  GPIO_InitStructure;
 	
	RCC_APB2PeriphClockCmd(SMBUS_RCC, ENABLE);	 //使能PB端口时钟
	
	GPIO_InitStructure.GPIO_Pin = SMBUS_SCK|SMBUS_SDA;		
	GPIO_InitStructure.GPIO_Mode = GPIO_Mode_Out_OD; 		
	GPIO_InitStructure.GPIO_Speed = GPIO_Speed_50MHz;		 //IO口速度为50MHz
	GPIO_Init(GPIOB, &GPIO_InitStructure);	
	
  SMBUS_SCK_H();
  SMBUS_SDA_H();
	
	TMP117_Initialization_DEFAULT();
}

/*******************************************************************************
 * 函数名: SMBus_ReadMemory
 * 功能: READ DATA FROM RAM/EEPROM  从RAM和EEPROM中读取数据
 * Input          : slaveAddress, command
 * Return         : Data
 * SMBus_ReadMemory(0x00, 0x07) 0x00 表示IIC设备的从地址 从0x07这个寄存器开始读取
*******************************************************************************/
u16 SMBus_ReadMemory(u8 slaveAddress, u8 command)
{
    u16 data;			// Data storage (DataH:DataL)
    u8 Pec;				// PEC byte storage
    u8 DataL=0;			// Low data byte storage
    u8 DataH=0;			// High data byte storage
    u8 arr[6];			// Buffer for the sent bytes
    u8 PecReg;			// Calculated PEC byte storage
    u8 ErrorCounter;	// Defines the number of the attempts for communication with MLX90614

    ErrorCounter=0x00;	// Initialising of ErrorCounter
	slaveAddress <<= 1;	//2-7位表示从机地址 从机地址左移一位，把读写位空出来
	
    do
    {
repeat:
        SMBus_StopBit();			    //If slave send NACK stop comunication
        --ErrorCounter;				    //Pre-decrement ErrorCounter
        if(!ErrorCounter) 			    //ErrorCounter=0?
        {
            break;					    //Yes,go out from do-while{}
        }
        SMBus_StartBit();				//Start condition
        if(SMBus_SendByte(slaveAddress))//Send SlaveAddress 最低位Wr=0表示接下来写命令
        {
            goto	repeat;			    //Repeat comunication again
        }
        if(SMBus_SendByte(command))	    //Send command
        {
            goto	repeat;		    	//Repeat comunication again
        }

        SMBus_StartBit();					//Repeated Start condition
        if(SMBus_SendByte(slaveAddress+1))	//Send SlaveAddress 最低位Rd=1表示接下来读数据
        {
            goto	repeat;             	//Repeat comunication again
        }

        DataH = SMBus_ReceiveByte(ACK);	//Read high data,master must send ACK
        DataL = SMBus_ReceiveByte(ACK); //Read low data,master must send ACK
        Pec = SMBus_ReceiveByte(NACK);	//Read PEC byte, master must send NACK
        SMBus_StopBit();				//Stop condition

        arr[5] = slaveAddress;		//
        arr[4] = command;			//
        arr[3] = slaveAddress+1;	//Load array arr
        arr[2] = DataH;				//
        arr[1] = DataL;				//
        arr[0] = 0;					//
        PecReg=PEC_Calculation(arr);//Calculate CRC 数据校验
    }
    while(PecReg != Pec);//If received and calculated CRC are equal go out from do-while{}
		data = (DataH<<8) | DataL;	//data=DataH:DataL
    return data;
}

/*******************************************************************************
 * 函数名: SMBus_WriteMemory
 * 功能: WRITE DATA TO EEPROM  向EEPROM中写入数据
 * Input          : slaveAddress, command, DataH, DataL
 * Return         : void
*******************************************************************************/
void SMBus_WriteMemory(u8 slaveAddress, u8 command, u8 DataH, u8 DataL)
{
	slaveAddress <<= 1;	//2-7位表示从机地址 从机地址左移一位，把读写位空出来
  SMBus_StopBit();			    //If slave send NACK stop comunication
  SMBus_StartBit();				//Start condition
	SMBus_SendByte(slaveAddress);//Send SlaveAddress 最低位Wr=0表示接下来写命令
	SMBus_SendByte(command);	    //Send command
	SMBus_SendByte(DataH);	//Send dataH
	SMBus_SendByte(DataL);	//Send dataL
  SMBus_StopBit();				//Stop condition
}

/*******************************************************************************
* 函数名: PEC_calculation
* 功能 : 数据校验
* Input          : pec[]
* Output         : None
* Return         : pec[0]-this byte contains calculated crc value
*******************************************************************************/
u8 PEC_Calculation(u8 pec[])
{
    u8 	crc[6];//存放多项式
    u8	BitPosition=47;//存放所有数据最高位，6*8=48 最高位就是47位
    u8	shift;
    u8	i;
    u8	j;
    u8	temp;

    do
    {
        /*Load pattern value 0x00 00 00 00 01 07*/
        crc[5]=0;
        crc[4]=0;
        crc[3]=0;
        crc[2]=0;
        crc[1]=0x01;
        crc[0]=0x07;

        /*Set maximum bit position at 47 ( six bytes byte5...byte0,MSbit=47)*/
        BitPosition=47;

        /*Set shift position at 0*/
        shift=0;

        /*Find first "1" in the transmited message beginning from the MSByte byte5*/
        i=5;
        j=0;
        while((pec[i]&(0x80>>j))==0 && i>0)
        {
            BitPosition--;
            if(j<7)
            {
                j++;
            }
            else
            {
                j=0x00;
                i--;
            }
        }/*End of while */

        /*Get shift value for pattern value*/
        shift=BitPosition-8;

        /*Shift pattern value */
        while(shift)
        {
            for(i=5; i<0xFF; i--)
            {
                if((crc[i-1]&0x80) && (i>0))
                {
                    temp=1;
                }
                else
                {
                    temp=0;
                }
                crc[i]<<=1;
                crc[i]+=temp;
            }/*End of for*/
            shift--;
        }/*End of while*/

        /*Exclusive OR between pec and crc*/
        for(i=0; i<=5; i++)
        {
            pec[i] ^=crc[i];
        }/*End of for*/
    }
    while(BitPosition>8); /*End of do-while*/

    return pec[0];
}

 /*******************************************************************************
 * 函数名: TMP117_get_Temperature
 * 功能: 计算并返回温度值
 * Return         : SMBus_ReadMemory(SA, TMP117_TemperatureRegister)*0.0078125
*******************************************************************************/
float TMP117_get_Temperature(void)
{   
	float temp;
	temp = SMBus_ReadMemory(SA, TMP117_TemperatureRegister)*0.0078125;
	return temp;
}

/*
   @Brief         Default Initialization
   @Description   传感器参数设置
   @Parameter     void
   @Return value  void
 */
void TMP117_Initialization_DEFAULT(void)
{
	TMP117_set_Configuration(0x02, 0x20);        //设置
	TMP117_set_Temperature_Offset(0x00, 0x00); //设置温度偏移量
  //TMP117_set_LowLimit(0x80,0x00);       //设置下限报警
  //TMP117_set_HighLimit(0x60,0x00);      //设置上限报警
	TMP117_set_EEPROM_Unlock(0x00, 0x00);   //设置解锁EEPROM
}

/*
   @Brief         Set Temperature Offset Value
   @Description   设置温度偏移量
   @Parameter     u8 first     ->  [15:8]
									u8 second    ->  [7:0]
   @Return value  void
 */
void TMP117_set_Temperature_Offset(u8 first, u8 second)
{
	SMBus_WriteMemory(SA, TMP117_Temperature_Offset, first, second);
}

/*  
   @Brief         Get Temperature Offset Value
   @Description   获取温度偏移量设置数据
   @Parameter     void
   @Return value  u16
 */
u16 TMP117_get_Temperature_Offset(void)
{
	u16 temp;
	temp = SMBus_ReadMemory(SA, TMP117_Temperature_Offset);
	return temp;      
}

/*
   @Brief         Set EEPROM Unlock Register Value
   @Description   设置EEPROM读写状态
   @Parameter     u8 first     ->  [15:8]
									u8 second    ->  [7:0]
   @Return value  void
 */
void TMP117_set_EEPROM_Unlock(u8 first, u8 second)
{
	SMBus_WriteMemory(SA, TMP117_EEPROM_Uclock, first, second);
}

/*
   @Brief         Set LowLimit
   @Description   设置报警温度的下限
   @Parameter     u8 first     ->  [15:8]
									u8 second    ->  [7:0]
   @Return value  void
 */
void TMP117_set_LowLimit(u8 first, u8 second)
{
	SMBus_WriteMemory(SA, TMP117_TemperatureLowLimit, first, second);
}

/*  
   @Brief         Get LowLimit
   @Description   获取温度报警下限值
   @Parameter     void
   @Return value  u16
 */
u16 TMP117_get_LowLimit(void)
{
	u16 temp;
	temp = SMBus_ReadMemory(SA, TMP117_TemperatureLowLimit);
	return temp;  
}

/*
   @Brief         Set HighLimit
   @Description   设置报警温度的上限
   @Parameter     u8 first     ->  [15:8]
									u8 second    ->  [7:0]
   @Return value  void
 */
void TMP117_set_HighLimit(u8 first, u8 second)
{
	SMBus_WriteMemory(SA, TMP117_TemperatureHighLimit, first, second);
}

/*  
   @Brief         Get Highlimit
   @Description   获取温度报警上限值
   @Parameter     void
   @Return value  u16
 */
u16 TMP117_get_HighLimit(void)
{
	u16 temp;
	temp = SMBus_ReadMemory(SA, TMP117_TemperatureHighLimit);
	return temp;        
}

/*
   @Brief         Set Configuration
   @Description   设置TMP117的配置
   @Parameter     u8 first     ->  [15:8]
									u8 second    ->  [7:0]
   @Return value  void
 */
void TMP117_set_Configuration(u8 first, u8 second)
{
	SMBus_WriteMemory(SA, TMP117_ConfigurationRegister, first, second);
}
/*  
   @Brief         Get Configuration
   @Description   获取TMP117配置数据
   @Parameter     void
   @Return value  u16
 */
u16 TMP117_get_Configuration(void)
{
	u16 temp;
	temp = SMBus_ReadMemory(SA, TMP117_ConfigurationRegister);
	return temp;       
}

/*  
   @Brief         Get ID Register
   @Description   获取TMP117的ID
   @Parameter     void
   @Return value  u16
 */
u16 TMP117_get_ID_Register(void)
{
	u16 temp;
	temp = SMBus_ReadMemory(SA, TMP117_ID_Register);
	return temp;
}

/*  
   @Brief         
   @Description   设置EEPROM1
   @Parameter     u8 first     ->  [15:8]
                  u8 second    ->  [7:0]
   @Return value  void
 */
void TMP117_set_EEPROM1(u8 first,u8 second)
{
	SMBus_WriteMemory(SA, TMP117_EEPROM1, first, second);
}

/*  
   @Brief         
   @Description   
   @Parameter     void
   @Return value  u16
 */
u16 TMP117_get_EEPROM1(void)
{
	u16 temp;
	temp = SMBus_ReadMemory(SA, TMP117_EEPROM1);
	return temp;      
}

/*  
   @Brief         
   @Description   
   @Parameter     u8 first     ->  [15:8]
                  u8 second    ->  [7:0]
   @Return value  void
 */
void TMP117_set_EEPROM2(u8 first,u8 second)
{
	SMBus_WriteMemory(SA, TMP117_EEPROM2, first, second);
}

/*  
   @Brief         
   @Description   
   @Parameter     void
   @Return value  u16
 */
u16 TMP117_get_EEPROM2(void)
{
	u16 temp;
	temp = SMBus_ReadMemory(SA, TMP117_EEPROM2);
	return temp;    
}

/*  
   @Brief         
   @Description   
   @Parameter     u8 first     ->  [15:8]
                  u8 second    ->  [7:0]
   @Return value  void
 */
void TMP117_set_EEPROM3(u8 first,u8 second)
{
	SMBus_WriteMemory(SA, TMP117_EEPROM3, first, second);
}

/*  
   @Brief         Get EEPROM3 Value
   @Description   
   @Parameter     void
   @Return value  u16
 */
u16 TMP117_get_EEPROM3(void)
{
	u16 temp;
	temp = SMBus_ReadMemory(SA, TMP117_EEPROM3);
	return temp;      
}
/*********************************END OF FILE*********************************/
